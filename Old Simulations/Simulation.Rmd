---
title: "Co-occurrence as a function of trait conservatism and competition"
author: "Ben Weinstein"
date: "Sunday, October 19, 2014"
output:
  html_document:
    toc: true
    number_sections: true
---

#Aim

To compare species co-occurrence under known simulations of niche conservatism, character divergence, and the combination of both forces. The goal is simulate two types of assemblages: assemblages where species occurrence was based on the response of a hypothetical trait along a single environment (abiotic filtering), and assemblages where species occurrence was based on the same hypothetical trait, but with the addition of character divergence among closely related species due to competition (abiotic filtering + competition).  These simulations will provide an expectation for the observed pattern of co-occurrence with increasing species similarity given known mechanisms of abiotic filtering and competition. 

#Approach
It seems like this simulation was already made by Matt Helmus in Ives and Helmus (2011). I've been trying take apart the pglmm.sim code from picante, but i've been unable to understand which variables control the level of trait conservatism in the simulation for modelflag = 2, and the level of repulsion for modelflag = 3. 

Reading Ives (2011) i can see that these models are '2) phylogenetic variation in species sensitivities to environmental gradients among communities, (3) phylogenetic repulsion in which closely related species are less likely to co-occur'

If i understand correctly, i would expect increasing probability of occurrence with decreasing distance to a species in an assemblage followed by some threshold of similiarity where the repulsion decrease the probability co-occurrence.

Here is what i would expect to see:

![](C:\Users\Ben\Documents\PhenoBayes\Conceptual.png)

```{r,warning=FALSE,message=FALSE}
require(caper)
require(picante)
require(vegan)
require(knitr)
require(geiger)
require(phytools)
require(doSNOW)
require(foreach)
require(ggplot2)
require(reshape2)
require(plyr)
opts_chunk$set(message=FALSE,warning=FALSE)
```

```{r load phylogeny}
gitpath<- "C:/Users/Ben/Documents/Pred_Obs/"
```

#Using pglmm.sim from picante

1. Create a phylogeny
2. Simulate trait data using pglmm.sim
3. Find distance to closest related species for each species for each assemblage
4. Logistic model of presence-absence

###Define wrapper function
This function takes in a phylogeny, runs pglmm.sim and calculates logistic model of presence as a function of distance to closest related species in an assemblage.

```{r}
modRun<-function(tree,modelflag,nsites,compscale=1){
  
  #run pglmm from Ives(2011)
  sim.dat<-pglmm.sim(tree=tree,nsites=nsites,modelflag=modelflag,second.env=FALSE,compscale)
  
  siteXsppm<-melt(sim.dat$Y)
  
  sp.lists<-apply(sim.dat$Y,1,function(x){
    names(x[x==1])
    })
  names(sp.lists)<-1:nrow(sim.dat$Y)
  
  colnames(siteXsppm)<-c("Locality","Species","P_A")
  
  #Seperate out presence and absence, see 
  PA_phylo<-rbind.fill(apply(siteXsppm,1,function(f){ 
    
    #The function which is begin repeated for all communities, in both present     and absent, for all species
    
    #get the related species (mean patristic distance,median, and sum of distances) 
    
    other<-unlist(sp.lists[names(sp.lists) %in% as.numeric(f[["Locality"]])])
    other.list<-other[!other %in% f[["Species"]]]
    
    #closest cophenetic neighbor
    hum.min<-min(ctrx[rownames(ctrx) %in% f[["Species"]],colnames(ctrx) %in% other.list],na.rm=TRUE)    
    d<-data.frame(Species=f[["Species"]],Locality=f[["Locality"]],Phylo.Relatedness=hum.min,P_A=f[["P_A"]])
    return(d)
    })
    )
  
  PA_phylo$P_A<-as.numeric(as.character(PA_phylo$P_A))  
  return(PA_phylo)}
```

##Model 2: 
Phylogenetic variation in species sensitivities to environmental gradients among communities
```{r}
#Make a phylogeny with a few species
trx<-rcoal(10)
plot(trx)
ctrx<-cophenetic(trx)

#parallel runs
cl<-makeCluster(2,"SOCK")
registerDoSNOW(cl)

modLoop<-foreach(i=1:40,.errorhandling="pass",
                 .packages=c("picante","reshape2","plyr")) %dopar% {
  out<-modRun(tree=trx,2,nsites=50,compscale=1)
  return(list(out))}

names(modLoop)<-1:length(modLoop)
moddf<-melt(modLoop,id.vars=colnames(modLoop[[1]][[1]]))

modIIloop<-ggplot(moddf,aes(x=Phylo.Relatedness,y=P_A,col=L1)) + geom_smooth(method="glm",family="binomial",formula=(y~(poly(x,2))),se=FALSE) + geom_smooth(method="glm",family="binomial",formula=(y~(poly(x,2))),se=FALSE,aes(group=1),linetype="dashed",col="black",size=.9) + labs("Iteration") + ylim(0,1) + theme_bw()+labs(x="Phylogenetic distance to closest related species in assemblage",y="Probability of presence") + scale_color_discrete(guide="none")

modIIloop
```

Colored lines are individual trials, dotted line is the mean

**Conclusion**
This works about as anticipated, though i'd really like to have control over the level of phylogenetic signal in the trait. Not sure why the co-occurrence increase in very distantly related species

## Model 3
Phylogenetic repulsion in which closely related species are less likely to co-occur'

```{r}
modLoop<-foreach(i=1:40,.errorhandling="pass",.packages=c("picante","reshape2","plyr")) %dopar% {
  out<-modRun(trx,3,nsites=50,compscale=1)
  return(list(out))}

names(modLoop)<-1:length(modLoop)
moddfb<-melt(modLoop,id.vars=colnames(modLoop[[1]][[1]]))

#remove any inf rows
moddfb<-moddfb[is.finite(moddfb$Phylo.Relatedness),]

modIIIloop<-ggplot(moddfb,aes(x=Phylo.Relatedness,y=P_A,col=L1)) + geom_smooth(method="glm",family="binomial",formula=(y~(poly(x,2))),se=FALSE) + geom_smooth(method="glm",family="binomial",formula=(y~(poly(x,2))),se=FALSE,aes(group=1),linetype="dashed",col="black",size=.9) + labs("Iteration") + ylim(0,1) + theme_bw() + labs(x="Phylogenetic distance to closest related species in assemblage",y="Probability of presence")+ scale_color_discrete(guide="none")


modIIIloop
```

Colored lines are individual runs, dotted line is the mean.

**Conclusion**

This doesn't really work as anticipated, you just see occurrence probability suppressed. Biologically you would hypothesize that character diverenge would be most relevant among closely related species. You see the predict pattern (decreased probability of occurrence among closely related species) in a couple trial runs, but it seems to be stochasitc. 

#Thoughts so far

* The number of species in the phylogeny needs to be low compared to the number of sites or else there is too much stocasticity in the simulations to actually see the pattern of relatedness.

* The compscale parameter is unclear to me, is it supposed to control the level of repulsion? This would be ideal, but varying the parameter does not seem to have any output on the model.

* There is way too much stochasticity in the pglmm.sim code, the individual trials are just crazy different.


###Varying compscale in pglmm.sim

Here is the correlation in traits plotted as a function of the compscale parameter. Increasing the parameter has no effect on the correlation. What i'm looking for is the parameter that i can increase which will increase/decrease the amount of phylogenetic signal in the trait. 

```{r}
#make a small phylogeny
tr<-rcoal(10)

#cophenetic distance
ct<-melt(cophenetic(tr))
colnames(ct)<-c("Species1","Species2","relatedness")

#sequence of compscales
sc<-seq(1,100,10)

comp_test<-lapply(sc,function(x){
  sim.dat<-pglmm.sim(tree=tr,nsites=10,modelflag=1,second.env=FALSE,compscale=x)
   
  mdat<-melt(sim.dat$Vphylo)
  colnames(mdat)<-c("Species1","Species2","trait_cor")
  
  mdat<-merge(mdat,ct,by=c("Species1","Species2"))
  
  #get cophenetic distance
  return(mdat)

})

#bind into a matrix
names(comp_test)<-sc
comp_dat<-melt(comp_test,id.var=c("Species1","Species2","trait_cor","relatedness"))

colnames(comp_dat)<-c("Species1","Species2","trait_cor","relatedness","compscale")

ggplot(comp_dat,aes(x=as.character(compscale),y=trait_cor,col=relatedness)) + geom_point() + geom_smooth(aes(group=1)) + scale_color_continuous(low="blue",high="red")
```

The y axis is correlated in trait values from pglmm.sim, the x axis is the compscale parameter.

**Conclusion**: The compscale parameter seems make no different to level of repulsion among species. What i had anticipated is the compscale parameter would relate to the strength of repulsion among closely related species.

Perhaps i need to start from the beginning:

#Using rescale function in geiger

Steps. 

1. Simulate tree and traits

2. Fit a model to the tree with desired parameters

3. Rescale the tree so the branch lengths fit that model

```{r}
geo <- get(data(geospiza))

plot(geo$phy)

#original data correlation
phylosig(x=geo$dat[,1],tree=geo$phy,method="lambda")

## transforming the tree
lphy <- rescale(geo$phy, "lambda", 0.62) # transform tree in one fell swoop
plot(lphy)
title("lambda: 0.62")

phylosig(x=geo$dat[,1],tree=lphy,method="lambda")
```

Okay that doesn't work as i thought, still needs work.
