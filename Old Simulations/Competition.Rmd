Non-linear competition coefficients for phylogenetic community structure analysis
========================================================

Using the pglmm.sim code to create assemblages where adaptation to an environmental gradient is phylogenetically correlated, but competition increases with relatedness. This is model III in the Ives and Helmus 2011 paper. 

Aim
---
To create a polynomial function to describe the competition coefficient, such that distantly related species compete exponentially less than closely related. To me, this makes biological sense, since a small difference when you are _closely_ related should make more of a difference in terms of niche space as the same distance when you are very _distantly related_.

Approach
---
Reviewing the code for the pglmm.sim function in the picante package, it appears this code be accomplished in one of two areas. Either in the code chunk for model III here (from picante function):

```{r,eval=FALSE}
Xscale <- 1
    Mscale <- 0
    Vscale1 <- 1
    Vscale2 <- 1
    compscale <- compscale
    b0scale <- 0
    Vcomp <- solve(V, diag(nspp))
    Vcomp <- Vcomp/max(Vcomp)
    Vcomp <- compscale * Vcomp
    iDcomp <- t(chol(Vcomp))
    colnames(Vcomp) <- rownames(Vcomp)
```

or under the repulsion flag:

```{r,eval=FALSE}
if (repulseflag == 1) {
    bcomp <- NULL
    for (i in 1:m) {
      bcomp <- cbind(bcomp, iDcomp %*% rnorm(nspp))
    }
    bcomp0 <- 0
    Xcomp <- exp(bcomp0 + bcomp)/(1 + exp(bcomp0 + bcomp))
    X <- X * t(Xcomp)}
```

Bring in data
----
```{r,message=FALSE,warning=FALSE}
require(picante)
require(ggplot2)
require(reshape)
#Set dropbox path
droppath<-"C:/Users/Ben/Dropbox/"

#Set git path
gitpath<-"C:/Users/Ben/Documents/Pred_Obs/"

#source input functions
source(paste(gitpath,"pglmmrichess.R",sep=""))

#Bring in phylogenetic and trait info
#Bring in Phylogenetic Data
trx<-read.nexus(paste(gitpath,"InputData\\ColombiaPhylogenyUM.tre",sep=""))
spnames<-read.table(paste(gitpath,"InputData\\SpNameTree.txt",sep=""), sep = "\t", header = TRUE)

#Replace tip.label with Spnames#
#replace the tiplabels with periods, which is the biomod default
trx$tip.label<-gsub("_",".",as.character(spnames$SpName))
plot(trx,cex=.3)
```


Testing the relationship between 'Vcomp', probability of occurrence and cophenetic distance 
----

```{r}

V <- vcv.phylo(trx, corr = TRUE)
nspp <- dim(V)[1]
compscale=100

Vcomp <- solve(V, diag(nspp))
Vcomp <- Vcomp/max(Vcomp)
Vcomp <- compscale * Vcomp
iDcomp <- t(chol(Vcomp))
colnames(Vcomp) <- rownames(Vcomp)


Vm<-melt(Vcomp)

colnames(Vm)<-c("To","From","Vcomp")


pco<-cophenetic(trx)
#remove within species relatedness
diag(pco)<-NA

co<-melt(pco)

colnames(co)<-c("To","From","cophenetic")

dat<-merge(Vm,co)

head(dat)

ggplot(dat,aes(x=cophenetic,Vcomp)) + geom_point()

```

This relationship appears exponential, which is good.

__Fit to probablity of occurrence__

```{r}
Vforsim <- V
  iD <- t(chol(Vforsim))
  mx <- t(as.matrix((-(nsites)/2):(nsites/2)))
  m <- length(mx)

    e <- iD %*% rnorm(nspp)
    e <- Vscale1 * (e - mean(e))/apply(e, 2, sd)
    bspp1 <- e
    X <- 1/(1 + exp(-(b0scale * array(1, c(m, 1)) %*% rnorm(nspp) + 
                        t(mx) %*% t(e))))
    X <- Xscale * X
    Xsmooth <- X
X1 <- diag(1 - Mscale * runif(m)) %*% X


##correlate each column 
corX<-melt(cor(X))

colnames(corX)<-c("To","From","Prob_Co_Occurrence")

#merge with dataframe
dat<-merge(dat,corX)

ggplot(dat,aes(x=cophenetic,y=Prob_Co_Occurrence,col=Vcomp)) + geom_point()
