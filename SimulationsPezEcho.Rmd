---
<<<<<<< HEAD
title: "Relatedness and Co-occurrence Simulation"
=======
title: "Pez Simulation"
>>>>>>> 54f2e721ce6c6e3bc9d0644d84b95a021d904851
author: "Ben Weinstein"
date: "Friday, October 24, 2014"
output:
  html_document:
    toc: true
    number_sections: true
---

**Disclaimer: The pez::scape function is a rewritten picante::pglmm.sim with much better user input written by Matt Helmus. This work is unpublished and is not to be distributed without explicit consent of package creator Will Pearse. Many thanks to Will and Matt Helmus for their work pushing the field forward.**

Aim
---
To describe the form of the function between distance to most closly related species and probability of co-occurrence under known mechanisms of assembly. I hypothesis that a this relationship is non-linear (2nd polynomial), such that species should increase in co-occurrence due to niche conservatism, then decrease in co-occurrence based on competition. I will then compare this simulated data with known mechanism to a empirical data using Andean Hummingbirds.

#Simulate Phylogeny

Start with a simple balanced phylogeny with branch lengths

```{r,warning=FALSE,message=FALSE,echo=FALSE}
library(knitr)
library(pez)
library(ape)
library(dplyr)
library(ggplot2)
library(reshape2)
library(phytools)
library(vegan)
library(RColorBrewer)
library(gridExtra)
opts_chunk$set(warning=FALSE,message=FALSE,echo=TRUE)
opts_chunk$set(cache=TRUE, cache.path = 'SimulationsPez_cache/', fig.path='figure/',fig.width=10)

#create Phylogeny
trx<-compute.brlen(stree(n=8,type="balanced"))
plot(trx)

#cophenetic distance
ctrx<-cophenetic(trx)
```

```{r,echo=FALSE}
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  require(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

#Simulation Parameters

Since this is a relatively unexplored landscape, let's assign a variable to all parameters and we can explore them.

Parameter | Description
------------- | -------------
tree|phylo object
scape.size|edge dimension of square landscape
g.center|strength of phylogenetic signal in species range centers
g.range|strength of phylogenetic signal in species range sizes
g.repulse|strength of phylogenetic repulsion
wd.all|niche width, larger values simulate broader range sizes
signal.center|simulate with phylosignal in range centers
signal.range|simulate with phylosignal in range size
same.range|make all range sizes equal
repulse|include phylogenetic repulsion in range centers
center.scale|adjust strength of phylogenetic attraction in range centers independent of g.center
range.scale|adjust strength of phylogenetic signal in range size independent of g.range
repulse.scale|adjust strength of phylogenetic repulsion independent of g.repulse
site.stoch.scale|adjust strength of random variation in species richness across sites
sd.center|sd in rnorm for the range centers, increase to get more variation in center values across species
sd.range|sd rnorm for the range sizes, increase to get more variation in range sizes across gradients
rho|Grafen branch adjustment of phylogenetic tree see corGrafen
th|probability threshold 10^-th above which species are considered present at a site

Before i can begin with simulations let's just begun with some basic predictions and see if the model works as anticipated.

##Niche Breadth and Occupancy
I would expect that as niche breadth increases, species would occupy more of the landscape. Trait evolution following Brownian Motion.

```{r}
#sequence of simulation sizes
niche.breadth<-seq(0,50,10)

#loop through all sizes with all other parameters = random
siz<-lapply(niche.breadth,function(x){
  sim.dat<-scape(trx, scape.size=20, g.center=1, g.range=1, g.repulse=1, wd.all=x, signal.center=TRUE, signal.range=FALSE, same.range=FALSE, repulse=FALSE,center.scale = 1, range.scale = 1, repulse.scale = 1, site.stoch.scale = 0, sd.center=3, sd.range=1,rho=NULL, th=80)
  sim.dat$Y
})
names(siz)<-niche.breadth
       
dat<-melt(siz)
colnames(dat)<-c("Site","Species","Presence","Breadth")

dat$Breadth<-as.numeric(dat$Breadth)

p<-ggplot(dat,aes(x=Breadth,y=Presence)) + stat_bin2d()
p + facet_wrap(~Species) + theme_bw() + stat_smooth(method="glm",family="binomial",aes(group=1)) + scale_fill_continuous(low="blue",high="red")
```

**Conclusion: As niches get wider, species occur in more cells. Hypothesis confirmed**

#Visualization

Every simulation needs a good visualization! Let's start simple.

```{r,fig.width=10}
probPlot<-function(data,col,facet){
X1<-melt(data$X1)
X1$Gradient<-"1"
X2<-melt(data$X2)
X2$Gradient<-"2"
colnames(X1)<-c("Site","Species","Prob","Gradient")
colnames(X2)<-c("Site","Species","Prob","Gradient")
f<-rbind(X1,X2)

p<-ggplot(f,aes_string(x="Site",col=col,y="Prob")) + geom_line() + theme_bw()
p
p<-p+ facet_wrap(as.formula(facet))
p + labs(col=col,y="Probability of Presence")
}

sim.dat<-scape(trx, scape.size=20, g.center=1, g.range=1, g.repulse=1, wd.all=30, signal.center=TRUE, signal.range=FALSE, same.range=FALSE, repulse=FALSE,center.scale = 1, range.scale = 1, repulse.scale = 1, site.stoch.scale = 0, sd.center=3, sd.range=1,rho=NULL, th=5)

probPlot(sim.dat,col="Gradient",facet="~Species")
```


```{r interaction matrix}
intMatrix<-function(d,tree){
colnames(d$Y)<-trx$tip.label
siteXsppm<-melt(d$Y)
colnames(siteXsppm)<-c("Locality","Species","P_A")

#get species lists
pres<-siteXsppm[!siteXsppm$P_A==0,]

f<-split(pres,pres$Locality)

#Get interactions of all species
comb<-lapply(f,function(g){
ns<-length(g$Species)
m<-matrix(nrow=ns,ncol=ns,1)
colnames(m)<-g$Species
rownames(m)<-g$Species
diag(m)<-NA
m
})

comb<-melt(comb)
#remove NA's
comb$Var1<-droplevels(comb$Var1)
comb$Var2<-droplevels(comb$Var2)

sp<-melt(table(comb$Var1,comb$Var2))
colnames(sp)<-c("Species1","Species2","int")
sp<-sp[!sp$int==0,]

sp$Species1<-factor(sp$Species1,levels=tree$tip.label)
sp$Species2<-factor(sp$Species2,levels=tree$tip.label)

ggplot(sp,aes(x=Species1,y=Species2,fill=int)) + geom_tile() + scale_fill_continuous(low="blue",high="red")
}
```


```{r}

###Species Ranges

#Function to plot species ranges on to the simulated grid. Needs to specify the same threshold as the scape th function (see questions). Optional argument to color species 


#color ramp function
gs.pal <- colorRampPalette(c("red","blue"),space="rgb")

gridplot<-function(x,tree,threshold,opt.color=FALSE,plot=TRUE,guide=TRUE){
  dat<-melt(x$sppXs)
  
  #Binary presences
  dat$binary<-(dat$value>threshold)
  colnames(dat)<-c("Site1","Site2","Species","value","binary")
  
  #remove empty slots
  dat[dat$binary==FALSE,"Species"]<-NA
  
  #remove NA's
  dat<-dat[!is.na(dat$Species),]
  
  #merge color profile
  col.tip<-data.frame(Label=tree$tip.label,col=gs.pal(length(tree$tip.label)))
  
  #species number
  col.tip$Species<-which(col.tip$Label %in% tree$tip.label)

  dat<-merge(dat,col.tip,by="Species")
  

  if(opt.color){
      if(!guide){
  p<-ggplot(dat,aes(x=Site1,y=Site2,fill=col)) + geom_tile(alpha=.7)  + theme_bw() + labs(fill="Species") + scale_fill_identity(labels=col.tip$Label)
  
    }
        else {
  p<-ggplot(dat,aes(x=Site1,y=Site2,fill=col)) + geom_tile(alpha=.7)  + theme_bw() + labs(fill="Species") + scale_fill_identity(labels=col.tip$Label,guide="legend")
              }
              }
  

  if(plot) {p}
  return(p)
}
```

Let's say i wanted to color by relatedness. One simple way to approximate this is to number the tips from 1 to n, and assume a divergent scale. This is not quite true, since the relationship is non linear, but its a start. 

**From now one, we have one clade 'blue' and one clade 'red'.**


```{r}
#Co-occurrence wrapper function
#For each simulation, i'm interested in the probability of occurrence as a function of distance to species nearest to in the assemblage. 

#Let's define a wrapper function to calculate this data.frame
co_occur<-function(d){

#reshape data
colnames(d$Y)<-trx$tip.label
siteXsppm<-melt(d$Y)
colnames(siteXsppm)<-c("Locality","Species","P_A")

f<-split(siteXsppm,siteXsppm$Locality)

#remove the localities with only 1 species
f<-f[sapply(f,function(x) sum(x$P_A)) > 1]

#Get closest related species in each site
closest<-lapply(f,function(x){
  #species present
  pres<-x$Species[x$P_A ==1]
    dis<-ctrx[trx$tip.label,pres]
    apply(dis,1,function(y){
      as.matrix(min(y[!y==0]))
      })
  }) 

#melt each list, a bit ugly
tomerge<-lapply(closest,function(x){
 dm<-melt(as.matrix(x))[,-2]
 colnames(dm)<-c("Species","Phylo.Relatedness")
 return(dm)})

tomerge<-melt(tomerge,id.var=c("Species"))

tomerge<-dcast(tomerge,...~variable)
colnames(tomerge)<-c("Species","Locality","Phylo.Relatedness")

#need to be characters not factors
siteXsppm$Locality<-as.character(siteXsppm$Locality)
tomerge$Locality<-as.character(tomerge$Locality)

PA_phylo<-merge(siteXsppm,tomerge,by=c("Locality","Species"))
PA_phylo$P_A<-as.numeric(PA_phylo$P_A)

#remove Inf lengths, no co-occurrence
PA_phylo[!is.finite(PA_phylo$Phylo.Relatedness),"Phylo.Relatedness"]<-NA

return(PA_phylo)
}
  
```

---

#Simulation 1: Lottery Model
Assemblage structure is made solely based BM model of evolution with strong stabilizing in traits along two environmental variables.

We expect a distance to related species and occurrence to be flat, with no explanatory power.

<<<<<<< HEAD
Visually, there should be a mix of blue (clade 1) and red (clade 2). 

=======
>>>>>>> 54f2e721ce6c6e3bc9d0644d84b95a021d904851
```{r}
#Threshold for presence
th=.6

sim.func<-function(){scape(trx, scape.size=20, g.center=1, g.range=1, g.repulse=1, wd.all=150, signal.center=FALSE, signal.range=FALSE, same.range=FALSE, repulse=FALSE,center.scale = 1, range.scale = 1, repulse.scale = 1, site.stoch.scale = 0, sd.center=1, sd.range=1,rho=NULL, th=th)}

sim.list<-replicate(20,sim.func(),simplify=FALSE)

gridlist<-lapply(sim.list[1:5],function(x){
  gridplot(x,tree=trx,threshold=-log10(th),opt.color=TRUE,guide=FALSE)})

multiplot(plotlist=gridlist,cols=3)

```

###Co-occurrence as a function of relatedness

```{r}
### Compute co-occurrence
sim.occur<-lapply(sim.list,function(x){
  phy<-co_occur(x)})

phy<-rbind_all(sim.occur)
ggplot(phy,aes(x=Phylo.Relatedness,y=P_A)) + geom_point() + geom_smooth(method="glm",family="binomial",formula=(y~(poly(x,2)))) + labs(y="Probability of Presence",x="Phylogenetic Distance to Nearest Species in the Assemblage")
```

**Conclusion: Hypothesis confirmed. **

---

#Simulation 2: Niche conservatism and co-occurrence

We expect that species in clade blue should overlap and species in clade red should overlap, but there should be no/little red-blue overlap.

We expect that as there are a more closely related species, there should be greater probability of co-occurrence.

```{r,height=20}
#Threshold for presence
th=.6

sim.func<-function(){scape(trx, scape.size=30, g.center=100, g.range=100, g.repulse=1, wd.all=150, signal.center=TRUE, signal.range=TRUE, same.range=TRUE, repulse=FALSE,center.scale = 1, range.scale = 1, repulse.scale = 1, site.stoch.scale = 0, sd.center=1, sd.range=1,rho=NULL, th=th)}

sim.list<-replicate(20,sim.func(),simplify=FALSE)

gridlist<-lapply(sim.list[1:6],function(x){
  gridplot(x,tree=trx,threshold=-log10(th),opt.color=TRUE,guide=FALSE)})
multiplot(plotlist=gridlist,cols=3)

#gridlist<-lapply(sim.list[1:5],function(x){
#probPlot(x,col="Species",facet="~Gradient")})

#multiplot(plotlist=gridlist,cols=1)

# gridlist<-lapply(sim.list[1:5],function(x){
# intMatrix(x,tree=trx)})
# 
# multiplot(plotlist=gridlist,cols=1)
```

###Co-occurrence as a function of relatedness

```{r}
### Compute co-occurrence
sim.occur<-list()
for (x in 1:length(sim.list)){
  phy<-co_occur(sim.list[[x]])
  phy$Iteration<-x
  sim.occur[[x]]<-phy
  }

phy<-rbind_all(sim.occur)

ggplot(phy,aes(x=Phylo.Relatedness,y=P_A))+ geom_point() + geom_smooth(aes(group=1),method="glm",family="binomial",formula=(y~(poly(x,2))))+ labs(y="Probability of Presence",x="Phylogenetic Distance to Nearest Species in the Assemblage")
```

**Conclusion: As relatedness increases, species tend to co-occur more. This fits out prediction of niche conservatism. **


```{r,fig.height=10,eval=FALSE}
###Vary level of trait conservatism

As disruptive selection causes trait evolution we should see clades co-occurring more frequently

th=.6
g<-seq(1,100,20)
plots<-lapply(g,function(x){

sim.dat<-scape(trx, scape.size=20, g.center=100, g.range=1, g.repulse=1, wd.all=150, signal.center=TRUE, signal.range=TRUE, same.range=TRUE, repulse=FALSE,center.scale = 1, range.scale = 1, repulse.scale = 1, site.stoch.scale = 0, sd.center=1, sd.range=1,rho=NULL, th=th)

p<-gridplot(sim.dat,tree=trx,threshold=-log10(th),opt.color=TRUE,plot=FALSE,guide=FALSE)
p<-p+ggtitle(paste("Trait Conservatism =",x))
})
multiplot(plotlist=plots,cols=3)

```


#Simulation 2: Niche Conservatism and competition

We would expect red and blue clades to seperate, but then fragment to create the checkerboard pattern of distribution (see papers by Simberloff and Gotelli)

```{r,fig.height=10}
sim.func<-function(){scape(trx, scape.size=20, g.center=100, g.range=1, g.repulse=10, wd.all=150, signal.center=TRUE, signal.range=FALSE, same.range=TRUE, repulse=TRUE,center.scale = 1, range.scale = 1, repulse.scale = 1, site.stoch.scale = 0, sd.center=1, sd.range=1,rho=NULL, th=th)}

sim.list<-replicate(20,sim.func(),simplify=FALSE)

gridlist<-lapply(sim.list[1:5],function(x){
  p<-gridplot(x,tree=trx,threshold=-log10(th),opt.color=TRUE,guide=F)})
multiplot(plotlist=gridlist,cols=3)

#gridlist<-lapply(sim.list[1:5],function(x){
#probPlot(x,col="Species",facet="~Gradient")})

#multiplot(plotlist=gridlist,cols=2)
```

###Co-occurrence as a function of relatedness

```{r}
th=.6

### Compute co-occurrence
sim.occur<-lapply(sim.list,function(x){
  phy<-co_occur(x)})

phy<-rbind_all(sim.occur)
ggplot(phy,aes(x=Phylo.Relatedness,y=P_A)) + geom_point() + geom_smooth(method="glm",family="binomial",formula=(y~(poly(x,2)))) + labs(y="Probability of Presence",x="Phylogenetic Distance to Nearest Species in the Assemblage")
```

**Conclusion: Hypothesis supported. We see a non-linear relationship between distance to closest related species and probability of co-occurrence.**

#Varying levels of repulsion and signal

One important question would be the sensitivity of the level of repulsion and range signal in creating our predicted pattern.


```{r,fig.height=10}
sim.func<-function(repulse,signal){scape(trx, scape.size=20, g.center=signal, g.range=1, g.repulse=repulse, wd.all=150, signal.center=TRUE, signal.range=FALSE, same.range=TRUE, repulse=TRUE,center.scale = 1, range.scale = 1, repulse.scale = 1, site.stoch.scale = 0, sd.center=1, sd.range=1,rho=NULL, th=th)}

#repeat 5 times for each set
sig<-seq(.01,3,.5)
repel<-seq(.01,3,.5)
ins<-expand.grid(sig,repel)
ins<-rbind(ins,ins,ins)
colnames(ins)<-c("Signal","Repulse")

#container
sim.list<-list()

for (x in 1:nrow(ins)){
  sim.list[[x]]<-sim.func(signal=ins[x,1],repulse=ins[x,2])
}

```

###Co-occurrence as a function of relatedness

```{r}
### Compute co-occurrence
sim.occur<-list()
for(x in 1:length(sim.list)){
  phy<-co_occur(sim.list[[x]])
  phy$Repulsion<-ins[x,"Repulse"]
  phy$Signal<-ins[x,"Signal"]
  sim.occur[[x]]<-phy
  }

phy<-rbind_all(sim.occur)
ggplot(phy,aes(x=Phylo.Relatedness,y=P_A,col=as.factor(Repulsion))) + geom_point() + geom_smooth(method="glm",family="binomial",formula=(y~(poly(x,2)))) + labs(y="Probability of Presence",x="Phylogenetic Distance to Nearest Species in the Assemblage") + theme_bw() + facet_wrap(~Signal) + labs(col="Repulsion") + scale_color_brewer(palette="RdBu")
```

Conclusion: The observed pattern is pretty robust to the exact parameters of g.center (facets) and g.repulse (color). 

#Questions

* Why is threshold (th) given as 10^-th, if the probability of presence is between 0 and 1, and is the joint probability of a species response to the environment, then $$ p(Presence_i) = P(Env1_i) * P(Env2_i)$$ In your default you have th=8, i.e any species whose joint probability is greater than .000000010 would be present. I would think that default would be 0.5? Am i not understanding the scale?

* I'm a bit confused about the dimensions of the presence absence matrix, if i asked for an edge size of 20, i should get 20^2=440 sites, but the dim of the matrix is 441. Ignore this first row for the moment?

* Is there any way to retrieve the trait values? Just to plot them on the tree and test that model is working as advertised. 

* Need to be think hard about the units and whether I am creating signal at unreasonable levels. 
