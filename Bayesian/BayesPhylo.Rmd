---
title: "Bayesian Phylogenetic Structure"
author: "Ben Weinstein"
date: "Tuesday, November 04, 2014"
output:
  html_document:
    toc: true
---

#Aim

Insights from comparing phylogenetic and trait community spacing has led to a renewed focus on whether interspecific competition shape species occurrence. Combining theories of niche conservatism and limiting similarity, species should co-occur more with closely related species up to a threshold of niche overlap, followed by a decrease in co-occurrence. I will test increasing model complexity, and a variety of priors to show model robustness.

</br>

#Bayesian Analysis of Co-occurrence as a function of relatedness.

## General Model Formula
$$ y \sim bern(p_i) $$

$$ logit(p_i) = \alpha + \beta *x + \gamma *x^2 $$

$$ \text{p is the probability of presence at a site}$$
$$ \text{x= cophenetic distance to the most closely related species }$$

```{r,echo=FALSE,warning=FALSE,message=FALSE}
library(knitr)
library(pez)
library(ape)
library(dplyr)
library(ggplot2)
library(reshape2)
library(vegan)
library(gridExtra)
library(R2jags)
library(boot)
library(stringr)
opts_chunk$set(warning=FALSE,message=FALSE)
opts_chunk$set(cache=TRUE, cache.path = 'BayesPhylo_cache/', fig.path='figure/',fig.width=10,echo=FALSE)

runs=25000
burns=22000
```

###Data

```{r load_data}
#Set dropbox path
droppath<-"C:/Users/Ben/Dropbox/"

#Set git path
gitpath<-"C:/Users/Ben/Documents/Pred_Obs/"

#Load image if desired
load(paste(droppath,"Thesis/Pred_Realized/Assemblages/Threshold0.2/Results/PredictedRealized.RData",sep=""))

#start with just the present sites
#head(PA_m2)

dat<-PA_m2[PA_m2$Hyp %in% "Env" & PA_m2$P_R %in% "PA_Binary",c("Species","Locality","P_A","Phylo.Relatedness")]

#remove infinites
dat<-dat[is.finite(dat$Phylo.Relatedness),]

#sample data
```

#Model 1 - Single Slope and Intercept

Species are constrained to have the same slope and intercept.

$$ Y_i \sim Bern(p_i) $$

$$ logit(p_i) = \alpha + \beta *x + \gamma *x^2 $$

WinBugs code:

```{r singlemodel,echo=FALSE,eval=TRUE}
setwd("C:/Users/Ben/Documents/Pred_Obs/Bayesian")
#Source model
source("Single.R")

#print model
print.noquote(readLines("Single.R"))
```

```{r jagsmodelsingle,eval=TRUE,echo=FALSE,fig.align='center',results='hide'}
#Input Data
Dat <- list(
  y=as.numeric(dat$P_A),
  dist=dat$Phylo.Relatedness)

InitStage <- function() {list(alpha=.1,beta=.1,gamma=.1)}

#Parameters to track
ParsStage <- c("alpha","beta","gamma")

#MCMC options
ni <- runs  # number of draws from the posterior
nt <- 1    #thinning rate
nb <- 0  # number to discard for burn-in
nc <- 2  # number of chains

#Jags

m = jags(inits = InitStage,
         n.chains=nc,
         model.file="Single.jags",
         working.directory=getwd(),
         data=Dat,
         parameters.to.save=ParsStage,
         n.thin=nt,
         n.iter=ni,
         n.burnin=nb,
         DIC=T)
```

```{r}
#Remove Burnin
pars<-melt(m$BUGSoutput$sims.array)
colnames(pars)<-c("Draw","Chain","parameter","estimate")
pars<-pars[!pars$Draw %in% 1:burns,]

#remove deviance
pars<-pars[!pars$parameter %in% "deviance",]
```

###Visualize posteriors

```{r,fig.height=3}
###Posterior Distributions
ggplot(pars,aes(x=estimate)) + geom_histogram() + ggtitle("Estimate of parameters") + facet_wrap(~parameter,scale="free") + theme_bw() 
```

###Visualize chains

```{r,fig.height=3}
###Chains
ggplot(pars,aes(x=Draw,col=as.factor(Chain),y=estimate)) + geom_line() + facet_wrap(~parameter,scale="free") + theme_bw() + labs(col="Chain")
```

###Output table

```{r}
parG<-group_by(pars,parameter)
out_single<-summarise(parG,mean=mean(estimate),lower=quantile(estimate,0.025),upper=quantile(estimate,0.975),sd=sd(estimate))
print(out_single)

#save.image("BayesPhylo.Rdata")
```

### Plot curves

```{r,echo=TRUE,eval=TRUE,fig.width=6,fig.align='center'}
#Load if needed

dpars<-dcast(pars,...~parameter)

#sample 1000 values
samp<-dpars[sample(1:nrow(dpars),1000),]

traj<-list()
for(x in 1:nrow(samp)){
  s<-samp[x,]
  p<-inv.logit(s$alpha + s$beta* dat$Phylo.Relatedness +s$gamma * dat$Phylo.Relatedness^2)
  traj[[x]]<-data.frame(x=dat$Phylo.Relatedness,y=p,Iteration=x)
}
    traj<-rbind_all(traj)

#summarise mean and interval
mtraj<-group_by(traj,x) %>% summarise(mean=mean(y),upper=quantile(y,0.975),lower=quantile(y,0.025))

ggplot(mtraj,aes(x=x,y=mean)) + geom_line(col="red",linetype="dashed") + geom_line(aes(y=upper),col="blue",linetype="dashed") + geom_line(aes(y=lower),col="blue",linetype="dashed")+ theme_bw() + labs(x="Phylogenetic distance to closest related species in an assemblage",y="Probability of occurrence")
```

#Model 2 - Varying Intercept

Species have differing intercepts but constrained to have the same slope. This equates to a single mechanism shaping relatedness, but accounting for differences in occupancy between species. 

$$ Y_i \sim Bern(p_i) $$

$$ logit(p_i) = \alpha_{Species[i]} + \beta *x + \gamma *x^2 $$
$$ \alpha_{Species[i]} \sim N(intercept,sigmaIntercept)$$

WinBugs code:

```{r printmodel,echo=FALSE,eval=TRUE}
setwd("C:/Users/Ben/Documents/Pred_Obs/Bayesian")
#Source model
source("SingleSlope.R")

#print model
print.noquote(readLines("SingleSlope.R"))
```

Run jags. 

```{r jagsmodelsingleslope,eval=TRUE,echo=FALSE,fig.align='center',results='hide'}
#Input Data
dat$Species<-factor(dat$Species)

Dat <- list(
  y=as.numeric(dat$P_A),
  dist=dat$Phylo.Relatedness,
  Species=as.numeric(dat$Species),
  s=nlevels(dat$Species))


InitStage <- function() {list(alpha=rep(0.1,Dat$s),beta=.1,gamma=.1)}

#Parameters to track
ParsStage <- c("alpha","beta","gamma","intercept","sigmaIntercept")

#MCMC options
ni <- runs  # number of draws from the posterior
nt <- 1    #thinning rate
nb <- 0  # number to discard for burn-in
nc <- 2  # number of chains

#Jags

m = jags(inits = InitStage,
         n.chains=nc,
         model.file="SingleSlope.jags",
         working.directory=getwd(),
         data=Dat,
         parameters.to.save=ParsStage,
         n.thin=nt,
         n.iter=ni,
         n.burnin=nb,
         DIC=T)
```

```{r}
#Remove Burnin
pars<-melt(m$BUGSoutput$sims.array)
colnames(pars)<-c("Draw","Chain","parameter","estimate")
pars<-pars[!pars$Draw %in% 1:burns,]

#seperate alpha,betas,gamma
allpars<-pars[!pars$Draw %in% 1:burns,]

spec<-pars[str_detect(string=pars$parameter,pattern=c("alpha")),]

#remove deviance and species level characters
pars<-pars[!str_detect(string=pars$parameter,pattern=c("alpha")),]
```

###Visualize posteriors

```{r,fig.height=3}
###Posterior Distributions
ggplot(pars,aes(x=estimate)) + geom_histogram() + ggtitle("Estimate of parameters") + facet_wrap(~parameter,scale="free") + theme_bw() 
```

###Visualize chains

```{r,fig.height=3}
###Chains
ggplot(pars,aes(x=Draw,col=as.factor(Chain),y=estimate)) + geom_line() + facet_wrap(~parameter,scale="free") + theme_bw() + labs(col="Chain")
```

###Output table

```{r}
parG<-group_by(pars,parameter)
out_slope<-summarise(parG,mean=mean(estimate),lower=quantile(estimate,0.025),upper=quantile(estimate,0.975),sd=sd(estimate))
print(out_single)

save.image("BayesPhylo.Rdata")
```

##View Species Intercept

```{r,fig.height=15}
spec$parameter<-droplevels(spec$parameter)

#merge with original table
di<-data.frame(parameter=levels(spec$parameter),Species=levels(dat$Species))

spec<-merge(spec,di,by="parameter")

ggplot(spec,aes(x=Species,y=estimate)) + geom_violin(fill="dark grey") + coord_flip()  + theme_bw()
```

##Plot species models

```{r,fig.height=40}
head(spec)

dpars<-dcast(allpars,...~parameter)
samp<-dpars[sample(1:nrow(dpars),1000),]

alpha_plot<-function(alpha,sp){
  
  #sample 1000 values
  
  traj<-list()
  for(x in 1:nrow(samp)){
    s<-samp[x,]
    p<-inv.logit(alpha[x] + s$beta* dat$Phylo.Relatedness +s$gamma * dat$Phylo.Relatedness^2)
    traj[[x]]<-data.frame(x=dat$Phylo.Relatedness,y=p,Iteration=x)
    }
  traj<-rbind_all(traj)
  
  #summarise mean and interval
  mtraj<-group_by(traj,x) %>% summarise(mean=mean(y),upper=quantile(y,0.975),lower=quantile(y,0.025))
  
  ggplot(mtraj,aes(x=x,y=mean)) + geom_line(col="red",linetype="dashed") + geom_line(aes(y=upper),col="blue",linetype="dashed") + geom_line(aes(y=lower),col="blue",linetype="dashed")+ theme_bw() + labs(x="",y="") + ggtitle(sp)
  }

alpha_index<-which(str_detect(string=colnames(samp),pattern=c("alpha")))

pl<-list()
for(x in 1:length(alpha_index)){
  i<-alpha_index[x]
  #Species
  sp<-di[x,"Species"]
  pl[[x]]<-alpha_plot(samp[,i],sp)
}

do.call("grid.arrange", c(pl, ncol=4))
```

##Model Fitting - Varying Intercept and Slope

Species are unconstrained in both slopes and intercepts. Species each repond differently and having different occupancies, but are drawn from a hyperprior 

$$ y \sim bern(p_i) $$

$$ logit(p_i) = \alpha_{Species[i]} + \beta_{Species[i]} *x + \gamma_{Species[i]} *x^2 $$
$$ \alpha_{Species[i]} \sim N(intercept,sigmaIntercept)$$
$$ \beta_{Species[i]} \sim N(slope,sigmaSlope)$$
$$ \gamma_{Species[i]} \sim N(slope2,sigmaSlope2)$$

WinBugs code:

```{r slopesandinterceptmodel,echo=FALSE,eval=TRUE}
#Source model
source("BPhylo.R")

#print model
print.noquote(readLines("BPhylo.R"))
```

Run jags

```{r jagsmodelvarying,eval=TRUE,echo=FALSE,fig.align='center',results='hide'}

dat$Species<-factor(dat$Species)

#Input Data
Dat <- list(
  y=as.numeric(dat$P_A),
  dist=dat$Phylo.Relatedness,
  Species=as.numeric(dat$Species),
  s=nlevels(dat$Species))

InitStage <- function() {list(alpha=rep(0.1,Dat$s),beta=rep(0.1,Dat$s),gamma=rep(0.1,Dat$s),intercept=0.001,tauIntercept=0.001,slope=0.1,tauSlope=0.001,tauSlope2=0.001,slope2=0.1)}

#Parameters to track
ParsStage <- c("intercept","slope","sigmaSlope","sigmaIntercept","slope2","sigmaSlope2","alpha","beta","gamma")

#MCMC options
ni <- runs  # number of draws from the 
nt <- 1    #thinning rate
nb <- 0  # number to discard for burn-in
nc <- 2  # number of chains

#Jags

m = jags(inits = InitStage,
         n.chains=nc,
         model.file="BPhylo.jags",
         working.directory=getwd(),
         data=Dat,
         parameters.to.save=ParsStage,
         n.thin=nt,
         n.iter=ni,
         n.burnin=nb,
         DIC=T)
```

```{r}
#Remove Burnin
pars<-melt(m$BUGSoutput$sims.array)
colnames(pars)<-c("Draw","Chain","parameter","estimate")
pars<-pars[!pars$Draw %in% 1:burns,]

#seperate alpha,betas,gamma
spec<-pars[str_detect(string=pars$parameter,pattern=c("beta|alpha|gamma|deviance")),]

#remove deviance and species level characters
pars<-pars[!str_detect(string=pars$parameter,pattern=c("beta|alpha|gamma|deviance")),]
```

###Visualize chains

```{r,cache=TRUE,fig.height=3}
###Posterior Distributions
ggplot(pars,aes(x=estimate)) + geom_histogram() + ggtitle("Estimate of parameters") + facet_wrap(~parameter,scale="free") + theme_bw() 
```

###Visualize posteriors

```{r,cache=TRUE,fig.height=3}
###Chains
ggplot(pars,aes(x=Draw,col=as.factor(Chain),y=estimate)) + geom_line() + facet_wrap(~parameter,scale="free") + theme_bw() + labs(col="Chain")
```

###Output table

```{r}
parG<-group_by(pars,parameter)
out_slopeintercept<-summarise(parG,mean=mean(estimate),lower=quantile(estimate,0.025),upper=quantile(estimate,0.975),sd=sd(estimate))
print(out_slopeintercept)

```

##View Species

#Comparison of Model Estimates 

Group by the parameters they are trying to predict
```{r,fig.width=12,fig.height=4}
comp<-list(Unconstrained_slope=out_slopeintercept,Uncontrained_Intercept=out_single,Constrained=out_slope)

compm<-melt(comp)
compm<-dcast(compm,...~variable)

compm[compm$parameter %in% c("intercept","alpha"),"Parm"]<-c("Intercept")
compm[compm$parameter %in% c("slope","beta"),"Parm"]<-c("beta")
compm[compm$parameter %in% c("slope2","gamma"),"Parm"]<-c("gamma")

ggplot(compm[!is.na(compm$Parm),],aes(x=L1,y=mean,ymax=upper,ymin=lower)) + geom_pointrange() + facet_wrap(~Parm,scales="free") + labs(y="Model",x="Posterior Estimate")

save.image("BayesPhylo.Rdata")
```
