---
title: "Bayesian Phylogenetic Structure"
author: "Ben Weinstein"
date: "Tuesday, November 04, 2014"
output:
  html_document:
    toc: true
---

#Aim
I will test increasing model complexity, and a variety of priors to show model robustness.

</br>

#Bayesian Analysis of Co-occurrence as a function of relatedness.

## General Model Formula
$$ y \sim bern(p_i) $$

$$ logit(p_i) = \alpha + \beta *x + \gamma *x^2 $$

$$ \text{p is the probability of presence at a site}$$
$$ \text{x= cophenetic distance to the most closely related species }$$

```{r,echo=FALSE,warning=FALSE,message=FALSE}
library(knitr)
library(pez)
library(ape)
library(dplyr)
library(ggplot2)
library(reshape2)
library(vegan)
library(gridExtra)
library(R2jags)
library(boot)
library(stringr)
opts_chunk$set(warning=FALSE,message=FALSE)
opts_chunk$set(cache=TRUE, cache.path = 'BayesPhylo_cache/', fig.path='figure/',fig.width=10,echo=FALSE)

runs=10000
burns=1000
```

###Data

```{r load_data}

#Set dropbox path
droppath<-"C:/Users/Ben/Dropbox/"

#Set git path
gitpath<-"C:/Users/Ben/Documents/Pred_Obs/"

#Load image if desired
load(paste(droppath,"Thesis/Pred_Realized/Assemblages/Threshold0.2/Results/Run.RData",sep=""))

#start with just the present sites
#head(PA_m2)

dat<-PA_m2[PA_m2$Assemblage %in% "Observed" & PA_m2$Tree %in% "Phylo" & PA_m2$Hyp %in% "Env" & PA_m2$P_R %in% "PA_Binary",c("Species","Locality","P_A","value")]

#remove infinites
dat<-dat[is.finite(dat$value),]

#sample data
dat<-dat[sample(1:nrow(dat),1000),]
kable(head(dat),row.names=F)
```

#Model 1 - Single Slope and Intercept

Species are constrained to have the same slope and intercept.

$$ Y_i \sim Bern(p_i) $$

$$ logit(p_i) = \alpha + \beta *x + \gamma *x^2 $$

```{r singlemodel,echo=FALSE,eval=FALSE}
setwd("C:/Users/Ben/Documents/Pred_Obs/Bayesian")
#Source model
source("Single.R")

#print model
print.noquote(readLines("Single.R"))
```

```{r jagsmodelsingle,eval=TRUE,echo=FALSE,fig.align='center'}
#Input Data
Dat <- list(
  y=as.numeric(dat$P_A),
  dist=dat$Phylo.Relatedness,
  Species=as.numeric(dat$Species),
  s=nlevels(dat$Species))

InitStage <- function() {list(alpha=.1,beta=.1,gamma=.1)}

#Parameters to track
ParsStage <- c("alpha","beta","gamma")

#MCMC options
ni <- runs  # number of draws from the posterior
nt <- 1    #thinning rate
nb <- 0  # number to discard for burn-in
nc <- 2  # number of chains

#Jags

m = jags(inits = InitStage,
         n.chains=nc,
         model.file="Single.jags",
         working.directory=getwd(),
         data=Dat,
         parameters.to.save=ParsStage,
         n.thin=nt,
         n.iter=ni,
         n.burnin=nb,
         DIC=T)
```

```{r}
#Remove Burnin
pars<-melt(m$BUGSoutput$sims.array)
colnames(pars)<-c("Draw","Chain","parameter","estimate")
pars<-pars[!pars$Draw %in% 1:burns,]

#remove deviance
pars<-pars[!pars$parameter %in% "deviance",]
```

###Visualize posteriors

```{r}
###Posterior Distributions
ggplot(pars,aes(x=estimate)) + geom_histogram() + ggtitle("Estimate of parameters") + facet_wrap(~parameter,scale="free") + theme_bw() 
```

###Visualize chains

```{r}
###Chains
ggplot(pars,aes(x=Draw,col=as.factor(Chain),y=estimate)) + geom_line() + facet_wrap(~parameter,scale="free") + theme_bw() + labs(col="Chain")
```

###Output table

```{r}
parG<-group_by(pars,parameter)
out<-summarise(parG,mean=mean(estimate),lower=quantile(estimate,0.025),upper=quantile(estimate,0.975),sd=sd(estimate))
print(out)

#save.image("BayesPhylo.Rdata")
```

### Plot curves

```{r,echo=TRUE,eval=TRUE,fig.width=6,fig.align='center'}
#Load if needed

dpars<-dcast(pars,...~parameter)

#sample 1000 values
samp<-dpars[sample(1:nrow(dpars),1000),]

traj<-list()
for(x in 1:nrow(samp)){
  s<-samp[x,]
  p<-inv.logit(s$alpha + s$beta* dat$value +s$gamma * dat$value^2)
  traj[[x]]<-data.frame(x=dat$value,y=p,Iteration=x)
}
    traj<-rbind_all(traj)

#summarise mean and interval
mtraj<-group_by(traj,x) %>% summarise(mean=mean(y),upper=quantile(y,0.975),lower=quantile(y,0.025))

ggplot(mtraj,aes(x=x,y=mean)) + geom_line(col="red",linetype="dashed") + geom_line(aes(y=upper),col="blue",linetype="dashed") + geom_line(aes(y=lower),col="blue",linetype="dashed")+ theme_bw() + labs(x="Phylogenetic distance to closest related species in an assemblage",y="Probability of occurrence")
```

#Model 2 - Varying Intercept

Species have differing intercepts but constrained to have the same slope. This equates to a single mechanism shaping relatedness, but accounting for differences in occupancy between species. 

$$ Y_i \sim Bern(p_i) $$

$$ logit(p_i) = \alpha_{Species[i]} + \beta *x + \gamma *x^2 $$
$$ \alpha_{Species[i]} \sim N(intercept,sigmaIntercept)$$

```{r printmodel,echo=FALSE,eval=FALSE}
setwd("C:/Users/Ben/Documents/Pred_Obs/Bayesian")
#Source model
source("SingleSlope.R")

#print model
print.noquote(readLines("SingleSlope.R"))
```

Run jags. 

```{r jagsmodelsingleslope,eval=TRUE,echo=FALSE,fig.align='center'}
#Input Data
Dat <- list(
  y=as.numeric(dat$P_A),
  dist=dat$value,
  Species=as.numeric(dat$Species),
  s=nlevels(dat$Species))


InitStage <- function() {list(alpha=rep(0.1,Dat$s),beta=.1,gamma=.1)}

#Parameters to track
ParsStage <- c("alpha","beta","gamma","intercept","sigmaIntercept")

#MCMC options
ni <- runs  # number of draws from the posterior
nt <- 1    #thinning rate
nb <- 0  # number to discard for burn-in
nc <- 2  # number of chains

#Jags

m = jags(inits = InitStage,
         n.chains=nc,
         model.file="BPhylo.jags",
         working.directory=getwd(),
         data=Dat,
         parameters.to.save=ParsStage,
         n.thin=nt,
         n.iter=ni,
         n.burnin=nb,
         DIC=T)
```

```{r}
#Remove Burnin
pars<-melt(m$BUGSoutput$sims.array)
colnames(pars)<-c("Draw","Chain","parameter","estimate")
pars<-pars[!pars$Draw %in% 1:burns,]

#seperate alpha,betas,gamma
spec<-pars[str_detect(string=pars$parameter,pattern=c("alpha")),]

#remove deviance and species level characters
pars<-pars[!str_detect(string=pars$parameter,pattern=c("alpha")),]
```

###Visualize posteriors

```{r}
###Posterior Distributions
ggplot(pars,aes(x=estimate)) + geom_histogram() + ggtitle("Estimate of parameters") + facet_wrap(~parameter,scale="free") + theme_bw() 
```

###Visualize chains

```{r}
###Chains

ggplot(pars,aes(x=Draw,col=as.factor(Chain),y=estimate)) + geom_line() + facet_wrap(~parameter,scale="free") + theme_bw() + labs(col="Chain")
```

###Output table

```{r}
parG<-group_by(pars,parameter)
out<-summarise(parG,mean=mean(estimate),lower=quantile(estimate,0.025),upper=quantile(estimate,0.975),sd=sd(estimate))
print(out)

save.image("BayesPhylo.Rdata")
```

##Model Fitting - Varying Intercept and Slope

Species are unconstrained in both slopes and intercepts. Species each repond differently and having different occupancies, but are drawn from a hyperprior 

$$ y \sim bern(p_i) $$

$$ logit(p_i) = \alpha_{Species[i]} + \beta_{Species[i]} *x + \gamma_{Species[i]} *x^2 $$
$$ \alpha_{Species[i]} \sim N(intercept,sigmaIntercept)$$
$$ \beta_{Species[i]} \sim N(slope,sigmaSlope)$$
$$ \gamma_{Species[i]} \sim N(slope2,sigmaSlope2)$$


```{r slopesandinterceptmodel,echo=FALSE,eval=TRUE}
load("C:/Users/Ben/Documents/Pred_Obs/Bayesian/BayesPhylo.Rdata")

setwd("C:/Users/Ben/Documents/Pred_Obs/Bayesian")
#Source model
source("BPhylo.R")

#print model
print.noquote(readLines("BPhylo.R"))

```

Run jags

```{r jagsmodelvarying,eval=TRUE,echo=FALSE,fig.align='center'}

#Input Data
Dat <- list(
  y=as.numeric(dat$P_A),
  dist=dat$value,
  Species=as.numeric(dat$Species),
  s=nlevels(dat$Species))

InitStage <- function() {list(alpha=rep(0.1,Dat$s),beta=rep(0.1,Dat$s),gamma=rep(0.1,Dat$s),intercept=0.001,tauIntercept=0.001,slope=0.1,tauSlope=0.001,tauSlope2=0.001,slope2=0.1)}

#Parameters to track
ParsStage <- c("intercept","slope","sigmaSlope","sigmaIntercept","slope2","sigmaSlope2","alpha","beta","gamma")

#MCMC options
ni <- runs  # number of draws from the 
nt <- 1    #thinning rate
nb <- 0  # number to discard for burn-in
nc <- 2  # number of chains

#Jags

m = jags(inits = InitStage,
         n.chains=nc,
         model.file="BPhylo.jags",
         working.directory=getwd(),
         data=Dat,
         parameters.to.save=ParsStage,
         n.thin=nt,
         n.iter=ni,
         n.burnin=nb,
         DIC=T)
```

```{r}
#Remove Burnin
pars<-melt(m$BUGSoutput$sims.array)
colnames(pars)<-c("Draw","Chain","parameter","estimate")

pars<-pars[!pars$Draw %in% 1:burns,]

#seperate alpha,betas,gamma
spec<-pars[str_detect(string=pars$parameter,pattern=c("beta|alpha|gamma|deviance")),]

#remove deviance and species level characters
pars<-pars[!str_detect(string=pars$parameter,pattern=c("beta|alpha|gamma|deviance")),]
```

###Visualize chains

```{r,cache=FALSE}
###Posterior Distributions

ggplot(pars,aes(x=estimate)) + geom_histogram() + ggtitle("Estimate of parameters") + facet_wrap(~parameter,scale="free") + theme_bw() 
```

###Visualize posteriors

```{r,cache=FALSE}
###Chains

ggplot(pars,aes(x=Draw,col=as.factor(Chain),y=estimate)) + geom_line() + facet_wrap(~parameter,scale="free") + theme_bw() + labs(col="Chain")
```

###Output table

```{r}
parG<-group_by(pars,parameter)
out<-summarise(parG,mean=mean(estimate),lower=quantile(estimate,0.025),upper=quantile(estimate,0.975),sd=sd(estimate))
print(out)

#save.image("BayesPhylo.Rdata")
```
