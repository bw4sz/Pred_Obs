---
title: "Structural independence in the logistic model"
author: "Ben Weinstein"
date: "Thursday, February 12, 2015"
output: pdf_document
---

```{r,message=FALSE,warning=FALSE}
library(knitr)
library(pez)
library(ape)
library(dplyr)
library(ggplot2)
library(reshape2)
library(boot)
library(vegan)
library(RColorBrewer)
library(gridExtra)
library(scales)
library(stringr)
library(picante)
library(foreach)
library(doSNOW)
library(lme4)
opts_chunk$set(warning=FALSE,message=FALSE,echo=TRUE,eval=T)
opts_chunk$set(cache=TRUE, cache.path = 'Independence_cache/', fig.path='figure/',fig.width=11,fig.height=6)

load("Independence.Rdata")

```

#Problem Statement

```
Suppose there are three species, 1, 2, and 3, with the distance between 1 and 2 = 1, and between 3 and the other two species = 2. Then assume three sites with each site having two species, with species 1, 2,  and 3 missing from sites 1, 2, and 3, respectively. So the data look like:
```

```{r}
dat <- data.frame(sp=c(1,2,3,1,2,3,1,2,3), site=c(1,1,1,2,2,2,3,3,3), Y=c(0,1,1,1,0,1,1,1,0), x=c(1,2,2,2,1,2,1,1,2))
```

```{r}
ggplot(dat,aes(x=x,y=Y)) + geom_point() + geom_smooth(method="lm")
glm(formula = Y ~ x, family = "binomial", data = dat)
```

So this gives a positive relationship between distance and  presence, even though the presence of species is random under the constraint that there are two species in each site. Obviously, this isn’t a desirable property. 

The reason that you get this is that the values of Y and x are structurally intertwined, so the values of Y aren’t independent.

I’m wondering if there is a simpler way to do this


----

----

----

#Aim
To address Tony's concern, i want to evaluate: 

* How this potential non-independence could effect results

* What is the range of covariates we could expect by random chance

```{r,echo=FALSE}
#Define co-occur function

co_occur<-function(dat,trx,ctrx){
 
f<-split(dat,dat$site)

#remove the localities with only 2 species
f<-f[sapply(f,function(x) sum(x$Y)) > 1]

if(length(f)==0){return(NA)}

#Get closest related species in each site
closest<-lapply(f,function(x){
  
  #species present
  pres<-x$sp[x$Y==1]
    dis<-ctrx[rownames(ctrx) %in% trx$tip.label,colnames(ctrx) %in% pres]
    apply(dis,1,function(y){
      as.matrix(min(y[!y==0]))
      })
  }) 

#melt each list, a bit ugly
tomerge<-lapply(closest,function(x){
 dm<-melt(as.matrix(x))[,-2]
 colnames(dm)<-c("sp","x")
 return(dm)})

tomerge<-melt(tomerge,id.var=c("sp"))

tomerge<-dcast(tomerge,...~variable)
colnames(tomerge)<-c("sp","site","x")

#need to be characters not factors
dat$site<-as.character(dat$site)
tomerge$site<-as.character(tomerge$site)

PA_phylo<-merge(dat,tomerge,by=c("site","sp"))
PA_phylo$Y<-as.numeric(PA_phylo$Y)

#remove Inf lengths, no co-occurrence
PA_phylo[!is.finite(PA_phylo$Y),"Y"]<-NA

return(PA_phylo)
}

```

##What does the relationship look like with increasing species and sites

Let's generalize this structure and see how this relationship changes with more sites and species, does it flatten out?

  * Each species draw is bernoulli trial
  * There is no min or max richness

Simulate phylogeny
  * Start with a balanced tree, we can check other topologies as well

Build a function to compute logistic regression for any given number of species in a phylogeny and sites

  * Occupancy is drawn from a bernoulli trial 
  
```{r}

simL<-function(species,sites){

#Simulate a balanced phylogeny
trx<-compute.brlen(stree(species,"balanced",tip.label=1:species))

#Cophenetic matrix
ctrx<-cophenetic(trx)

#Create data.frame
sp=rep(1:species,sites)
site=as.vector(sapply(1:sites,function(x) rep(x,species)))
dat<-data.frame(sp,site)

#Presence/absence
dat$Y<-rbinom(sites*species,1,.5)

#Compute co-occurrence
dat<-co_occur(dat,trx,ctrx)
return(dat)}
```

Iterate over a large parameter space

```{r}
species.space<-rep(2^(3:7))
site.space<-rep(c(20,40,60,80,100),200)
```

#Simulate Data

  * For each site and species combination draw random occurrence
  
```{r,eval=F}
simdat<-lapply(species.space,function(x){ 
    lapply(site.space,function(y){
      l<-simL(x,y)  
  mod<-glm(data=l,formula = Y ~ x, family = "binomial") 
  mode<-summary(mod)$coefficients[,"Estimate"]
  data.frame(Intercept=mode[[1]],x=mode[[2]])
      })
})
  
#name layers
names(simdat)<-species.space

for(x in 1:length(simdat)){
  names(simdat[[x]])<-site.space
}

```

## View regression
```{r,fig.height=5}
mdat<-melt(simdat)
colnames(mdat)<-c("variable","Estimate","Sites","Species")

mdat$Sites<-as.numeric(mdat$Sites)
mdat$Species<-as.numeric(mdat$Species)

ggplot(mdat,aes(x=as.factor(Species),y=Estimate,fill=as.factor(Sites))) + geom_violin() + theme_bw() + labs(fill="# of Sites",x="# of Species", y= "Covariate Estimate for phylogenetic distance to closest related species") + coord_flip() + facet_wrap(~Sites,ncol=5) + ggtitle("Null Distribution: Sensitivity of GLM to # of Sites and Species")
```

### Conclusion

The relationship between x and y is indeed structured, since a species occurring at a site changes the phylogenetic composition at the site. This relationship is largely the same across number of sites and number of species. This suggestions its the topology of the tree that controls the null distribution of potential covariates. 
The way forward is then to randomize the tips of the phylogeny by creating random assemblages of the same size and species prevalence and compare the observed glm estimate  with the null distribution of covariate estimates and consider how probability of observing our estimate given the topology of our tree.

##Observed versus null distribution

Read in data
```{r}
#read in tree
trx<-read.tree("InputData\\hum294.tre")

new<-str_extract(trx$tip.label,"(\\w+).(\\w+)")
#get duplicates
trx<-drop.tip(trx,trx$tip.label[duplicated(new)])

#name tips.
trx$tip.label<-str_extract(trx$tip.label,"(\\w+).(\\w+)")

ctrx<-cophenetic(trx)

#standardize the distances, just to avoid rounding error.
ctrx<-ctrx/max(ctrx)

siteXspp<-read.csv("C:/Users/Ben/Dropbox/Thesis/Pred_Realized/Assemblages/SiteXsppraster.csv",row.names=1)

dim(siteXspp)
print("133 Species at 201 Sites")
source("SpeciesOverlapSourceFunctions.R")

```

```{r}
#definite function to randomize assemblage and compute glm
randomCo<-function(){
  r<-randomizeMatrix(siteXspp,"independentswap")
  l<-co_occur(melt(r))
  mod<-glm(data=l,formula = P_A ~ poly(Phylo.Relatedness,2,raw=TRUE), family = "binomial") 
  mode<-summary(mod)$coefficients[,"Estimate"]
  data.frame(Intercept=mode[[1]],x=mode[[2]],x2=mode[[3]])
}
```

```{r,eval=FALSE}
cl<-makeCluster(20,"SOCK")
registerDoSNOW(cl)
out<-foreach(x=1:5000,.packages=c("picante","reshape2")) %dopar% {
  randomCo()
  }

stopCluster(cl)
```

```{r}
#melt data frame
dat<-melt(out)
#remove last column
dat<-dat[,-3]
```

#Observed Relationship

What is our observed relationship between probability of presence and 
  * Fit a glm without a random effect
  * Fit a mixed model (glmer) with a species level random effect

Since i have to compute 5000 models, its not really feasible to make a null distribution in the bayesian approach, but we can compare our results here to the predicted function at the end.

###GLM
```{r model fit,fig.height=4,fig.width=4,cache=TRUE,eval=TRUE}

l<-co_occur(melt(as.matrix(siteXspp)))

#glm observed
mod<-glm(data=l,formula = as.factor(P_A) ~ poly(Phylo.Relatedness,2,raw=TRUE), family = "binomial") 
summary(mod)
mode<-summary(mod)$coefficients[,"Estimate"]
observed<-melt(data.frame(Intercept=mode[[1]],x=mode[[2]],x2=mode[[3]]))
confint.glm<-confint(mod)
predict.glm<-data.frame(x=l$Phylo.Relatedness,y=predict(mod))
```

### GLMM (1|Species)
```{r,eval=TRUE}
mod2<-glmer(data=l,formula = as.factor(P_A) ~ poly(Phylo.Relatedness,2,raw=T) + (1|Species), family = "binomial")
smod2<-summary(mod2)
smod2
coef.glmer<-smod2$coefficients
observed.glmer<-melt(data.frame(Intercept=coef.glmer[1,1],x=coef.glmer[2,1],x2=coef.glmer[3,1]))
confint.glmer<-confint(mod2)
predict.glmer<-data.frame(x=l$Phylo.Relatedness,y=predict(mod2))

observed.bayes<-melt(data.frame(Intercept=-1.96,x=6.64,x2=-11.69))

#bind results
coef.dat<-melt(list(GLM=observed,GLMM=observed.glmer,Bayesian=observed.bayes))
```

###Interpretation: 
Both the glm and glmer results suggest that the polynomial 'fixed' effect is signficant. Normally i'd be concerned with high corerlation between fixed effects, but it makes sense how the linear and polynomial terms are linked. 

#Visualize null distribution versus observed value

  * View the mean estimates against the null distribution
  
```{r,eval=TRUE}

quants<-group_by(dat,variable) %>% summarize(lower=quantile(value,0.025),upper=quantile(value,0.975))

ggplot(dat,aes(x=value)) + geom_histogram() + facet_wrap(~variable,scales="free") + theme_bw() + ggtitle("Null Distribution of GLM and GLMM Covariates") + geom_vline(data=coef.dat,aes(xintercept=value,col=L1),linetype='dashed',size=1.1,show_guide = T) + geom_vline(data=quants,aes(xintercept=lower),col='black',size=.7)+ geom_vline(data=quants,aes(xintercept=upper),col='black',size=.7) + labs(col="Modeling Approach")
  
```

The thin black line are the central 95th quantiles of the null distribution for each parameter based on 5000 glm models for randomized data. We compare this null distrubtion to the observed mean covariate estimates for glm glmm, and bayesian models. 
From this figure I infer that the the probability of getting our result by the intertwined structure of the model is very low. This is because to get our result we need to get both the x and x^2 terms, they are not independent, so the joint probability of getting our result is even more remote than just $\alpha=0.05$ would suggest.

#Simulated Trajectories

```{r,cache=TRUE}

#define trajectory function
trajF<-function(intercept,linear,polynomial,x){
  p<-inv.logit(intercept + linear * x  + polynomial * x^2)
  return(p)
}

s<-seq(0,1,0.01)

#Simulated trajectories
ynew<-lapply(out,function(x){
  y<-trajF(x$Intercept,x$x,x$x2,s)
  data.frame(s,y)
  })

ynew<-rbind_all(ynew)

conf<-group_by(ynew,s) %>% summarise(mean=mean(y),upper=quantile(y,0.975),lower=quantile(y,0.025))


#Observed glm
yobs.glm<-data.frame(x=l$Phylo.Relatedness,y=trajF(observed[1,2],observed[2,2],observed[3,2],l$Phylo.Relatedness))

#observed glmer (1|Species)
yobs.glmer<-data.frame(x=l$Phylo.Relatedness,y=trajF(observed.glmer[1,2],observed.glmer[2,2],observed.glmer[3,2],l$Phylo.Relatedness))

#observed bayesian with species level effect
confint.bayes<-data.frame("2.5%"=c(-2.44,4.72,-9.37),"97.5%"=c(-1.48,8.62,-14.71))
colnames(confint.bayes)<-colnames(confint.glm)

yobs.bayes<-data.frame(x=l$Phylo.Relatedness,y=trajF(observed.bayes[1,2],observed.bayes[2,2],observed.bayes[3,2],l$Phylo.Relatedness))

obs<-melt(list(GLM=yobs.glm,Mixed_Effects=yobs.glmer,Bayes=yobs.bayes),id.var=c("x","y"))

ggplot(data=conf,aes(x=s,y=mean)) + geom_ribbon(aes(ymin=lower,ymax=upper),fill='gray80') + theme_bw()  + labs(x="Phylogenetic distance to the closest related species",y="Probability of Presence") + geom_line(data=obs,aes(x=x,y=y,col=L1),show_guide=TRUE,size=1.5,linetype="dashed") + ggtitle("Observed versus null fit") + geom_line(aes(y=mean)) + labs(col="Modeling Approach") 

```

The grey area is the null distrubition of glm estimates. The red line is the Bayesian estimate, teal is the glm mixed effects (1|Species), and the green is glm without accounting for species differences. 

##CI Intervals
The confidence intervals are not show here, and there is quite a bit of variance in the bayesian thats not quite as extensive in the glmm.

```{r}
co<-list(GLM=confint.glm,GLMM=confint.glmer[-1,],Bayes=confint.bayes)
#standardize row and columne names
co<-lapply(co,function(x){
  rownames(x)<-c("Intercept","Linear","Polynomial")
  colnames(x)<-c("Lower","Upper")
  return(as.matrix(x))
})
co<-melt(co)
co<-dcast(co,...~Var2)
ggplot(co,aes(x=L1,ymin=Lower,ymax=Upper))  + facet_wrap(~Var1,scales="free") + geom_linerange(size=1.4) + theme_bw() + ggtitle("Confidence Intervals of Estimates") + labs(x="Model",y="Estimate")
```

```{r}
save.image("Independence.Rdata")
#load image if desired
load("Independence.Rdata")
```